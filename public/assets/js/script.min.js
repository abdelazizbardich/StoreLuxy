$(document).ready(function () {
 $.ajaxSetup({
  beforeSend: function (xhr, type) {
   if (!type.crossDomain) {
     xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
   }
  },
 });
 Notiflix.Notify.Init({
  position: 'left-top',
 });
 $(".has-mega-menu").click(function (e) {
  //e.preventDefault();
 });
 $("#close-search-box").click(function () {
  $("#searsh-box").fadeOut();
 });
 $("#show-search-box").click(function (e) {
  e.preventDefault();
  $("#searsh-box").fadeIn();
 });
 $("#back-to-top").click(function () {
  window.scroll({
   top: 0,
   left: 0,
   behavior: 'smooth'
  });
 });
 $("#show-side-menu").click(function () {
  $("#side-menu").css('transform', 'translateX(0%)');
  $("#side-menu").addClass('side-menu-show');
 });
 $("#close-side-menu").click(function () {
  $("#side-menu").removeClass('side-menu-show');
  $("#side-menu").delay(500).css('transform', 'translateX(-150%)');
 
 });
 $("#show-more-details").click(function () {
  $(".product-details-content").toggleClass('heightAuto');
  $(this).toggleClass('rotateZ180deg');
  $(".feader").toggle();
 });
 $("#close-chat").click(function () {
  $.get({
   url: '/ajax/desableChatMessage',
   data: { _token: "{{ csrf_token() }}" },
   success: function (res) {
     console.log(res);
     $("#chat-btn").children("div").remove();
   }
  });
 
 });
 $("img.lightZoom").click(function () {
  $("#lightBox").find("img").attr('src', $(this).attr('src'));
  $("#lightBox").fadeIn('slow');
 });
 $("#close-light-box").click(function () {
  $("#lightBox").fadeOut('slow');
  $("#lightBox").find("img").attr('src', '');
 });
 $("#light-box-overflow").click(function () {
  $("#lightBox").fadeOut('slow');
  $("#lightBox").find("img").attr('src', '');
 });
 $(".str").click(function () {
  $(".starsList").find('img').css('opacity', '.5');
  $(".starsList").find('input[type="checkbox"]').prop('checked', false);
  let x = parseInt($(this).attr('data-order')); let i = 1;
  while (i <= x) {
   let strli = ".starsList .str[data-order=" + i + "]";
   $(strli).find('img').css('opacity', '1');
   $(strli).find('input[type="checkbox"]').prop('checked', true);
   i++;
  }
  $("#strCount").val(x);
 });
 
 $(".qte_input .minus").click(function () {
  let value = $(this).parents(".qte_input").find('input').val();
  if (!value) { value = 0; }
  value = parseInt(value);
  if (value > 1) {
   $(this).parents(".qte_input").find('input').val(value - 1);
  }
 });
 $(".qte_input .plus").click(function () {
  let value = $(this).parents(".qte_input").find('input').val();
  let maxQte = $(this).parents(".qte_input").find('input').attr('data-max');
  if(maxQte == value){Notiflix.Notify.Warning('Nous n\'en avons plus en stock'); return false;}
  if (!value) { value = 0; }
  value = parseInt(value);
  $(this).parents(".qte_input").find('input').val(value + 1);
 });
 
 $(".cart-row").find(".cart-row-close").click(function () {
  $(this).parents(".cart-row").remove();
 });
 $("#order-notis").find(".close").click(function () {
  $.get({
   url: '/ajax/desableOrderNotice',
   data: { _token: "{{ csrf_token() }}" },
   success: function (res) {
     $("#order-notis").remove();
   }
  });
 
 });
 
 $("#fixed-carte").find("#close-fixed-carte").click(function () {
  $(this).parents("#fixed-carte").css('transform', 'translateX(150%)');
 });
 $(".btn-add-to-carte").click(function (e) {
  e.preventDefault();
  let pId = $(this).attr('data-id');
  let url = $('meta[name="site-storage-url"]').attr('content');
  $.get({
   url: '/ajax/addToCart/' + pId,
   data: { _token: "{{ csrf_token() }}" },
   success: function (res) {
     if (res == '0') {
        Notiflix.Notify.Warning('le produit est déjà dans le panier');
        $("#fixed-carte").css('transform', 'translateX(0px)');
        return false;
     }
     console.log(res);
     data = JSON.parse(res);
 
     let product = "";
     product += '<div class="fixed-carte-product col-6 col-sm-6 col-md-4 col-lg-4 col-xl-4" data-id="' + data['id'] + '">';
     product += '<div style="padding: 5px;position: relative;"><img class="img-fluid" style="width: 100%;margin-bottom: 10px;" src="' +url+'/'+ data['thumbnail']['file'] + '" />';
     product += '<p class="text-break" style="font-size: 14px;line-height: 19px;margin-bottom: 5px;width: 100%;">' + data['name'] + '</p>';
     product += '<p class="text-break" style="width: 100%;font-size: 14px;line-height: 19px;color:red">' + data['price'] + 'Dh</p><button onclick="removeFromCarte(this)" data-id="' + data['id'] + '" class="btn btn-primary shadow-sm" type="button" style="border: none;color: #ff0000;box-shadow: none;position: absolute;top: -10px;right: -10px;background-color: rgb(255,255,255);border-radius: 50px;border: 2px solid rgb(255,223,0);width: 20px;height: 20px;font-size: 12px;text-align: center;padding: 0px;"><i class="fa fa-close close-fixed-carte-product" style="display: block;"></i></button>';
     product += '</div>';
     product += '</div>';
     $('#fixed-carte-product-row').append(product);
     Notiflix.Notify.Success('Le produit est ajouté au panier');
     $("#fixed-carte").css('transform', 'translateX(0px)');
     $('.fixed-carte-product[data-id="' + data['id'] + '"]').addClass('animate__animated animate__zoomIn');
     let cartCountBadge = $('.cart-count-badge').text();
     $('.cart-count-badge').text(parseInt(cartCountBadge) + 1);
 
   }
  });
 });
 if ($("#order-notis").length > 0) { setInterval(orderNotis, 30000); }
 // Newsletter
 $('#newsletterForm').submit(function (e) {
  e.preventDefault();
  let email = $(this).find('#newsemail').val();
  var CSRF_TOKEN = $('meta[name="csrf-token"]').attr('content');
  $.post({
   url: '/ajax/newsletter/register',
   data: { _token: CSRF_TOKEN, 'email': email },
   success: function (res) {
     console.log(res);
     if (res == 1) {
        Notiflix.Notify.Success('Merci de vous être abonné à notre newsletter');
        $(this).find('#newsemail').val('');
     }
   }
  });
 });
 // new post share
 $('.sharePost').click(function () {
  var CSRF_TOKEN = $('meta[name="csrf-token"]').attr('content');
  let id = $(this).attr('data-id');
  $.get({
   url: '/ajax/post/newshare/' + id
  });
 });
 // oreder now
 $('.order-now').click(function () {
  let Id = $(this).attr('data-id');
  let Qte = $('.product-qte').val();
  window.location.href = '/commandez-maintenant/' + Id + '/' + Qte;
 })
 $('.product_qte_group').click(function () {
  let productQte = parseInt($(this).find('input.product_qte').val());
  cartTotal = parseFloat($('.product-price').text()) * productQte;
  $('.product-total,.total-cart').text(cartTotal);
  let shippingCost = parseFloat($('.shipping-cost').text());
  let tax = parseFloat($('.tax').text());
  totalOrder = cartTotal + shippingCost + tax;
  $('.total-order').text(totalOrder);
 });
 if ($('.city').val() != null) {
  let selectedOption = $('.city').val();
  let shippingCost = parseFloat($('.city').find('option[value="' + selectedOption + '"]').attr('data-cost'));
  if (!shippingCost) { shippingCost = 0; }
  $('.shipping-cost').text(shippingCost);
  let cartTotal = parseFloat($('.product-total').text());
  let tax = parseFloat($('.tax').text());
  totalOrder = cartTotal + shippingCost + tax;
  $('.total-order').text(totalOrder);
 }
 $('.city').change(function () {
  let selectedOption = $(this).val();
  let shippingCost = parseFloat($(this).find('option[value="' + selectedOption + '"]').attr('data-cost'));
  if (!shippingCost) { shippingCost = 0; }
  $('.shipping-cost').text(shippingCost);
  let cartTotal = parseFloat($('.product-total').text());
  let tax = parseFloat($('.tax').text());
  totalOrder = cartTotal + shippingCost + tax;
  $('.total-order').text(totalOrder);
 
 });
 $('.carte-product').find('.qte_input').click(function () {
  let qte = parseInt($(this).find('input').val());
  let price = parseFloat($(this).parents('.carte-product').find('.product-price').text());
  TotalPrice = qte * price;
  $(this).parents('.carte-product').find('.total-product-price').text(TotalPrice);
 });
});
 
function removeFromCarte(element) {
 
 let pId = $(element).attr('data-id');
 $.get({
  url: '/ajax/removeFromCart/' + pId,
  data: { _token: "{{ csrf_token() }}" },
  success: function (res) {
   if (res == 1) {
     let cartCountBadge = $('.cart-count-badge').text();
     $('.cart-count-badge').text(parseInt(cartCountBadge) - 1);
     Notiflix.Notify.Success('Le produit a été retiré du panier');
   }
  }
 });
 $(element).parents(".fixed-carte-product").addClass('animate__animated animate__zoomOut', 500);
 setTimeout(
  function () {
   $(element).parents(".fixed-carte-product").remove();
  }, 500);
 
}

function orderNotis() {
  let url = $('meta[name="site-storage-url"]').attr('content');
 $.get({
  url: '/ajax/getRandomeProduct',
  data: { _token: "{{ csrf_token() }}" },
  success: function (res) {
   let data = JSON.parse(res);
   $("#order-notis").find(".thumbnail").attr('src',url+'/'+data['thumbnail']);
   $("#order-notis").find(".title").text(data['name']);
   $("#order-notis").find(".price").text(data['price'] + ' Dh');
   $("#order-notis").slideDown();
   /*var audio = new Audio('/assets/sounds/alert.wav');
   audio.play();*/
   setTimeout(function () { $("#order-notis").slideUp(); }, 15000);
  }
 });
 
}